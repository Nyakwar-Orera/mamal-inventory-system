{% extends 'layouts/base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Dashboard</h2>
        <div>
            <button id="themeToggle" class="btn btn-outline-secondary me-2">üåô Toggle Theme</button>
            <a href="{{ url_for('export_dashboard_data') }}" class="btn btn-success">üìÅ Export Data</a>
        </div>
    </div>

    <!-- Notifications -->
    <div class="row mb-4">
        {% if pending_maintenance > 0 %}
        <div class="col-md-6">
            <div class="alert alert-warning shadow-sm">
                üîß <strong>{{ pending_maintenance }}</strong> maintenance tasks are pending.
            </div>
        </div>
        {% endif %}

        {% if low_stock|length > 0 %}
        <div class="col-md-6">
            <div class="alert alert-danger shadow-sm">
                ‚ö†Ô∏è <strong>{{ low_stock|length }}</strong> items are low on stock.
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Asset Summary -->
    <div class="row">
        {% for key, value in asset_counts.items() %}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h5 class="card-title text-capitalize">{{ key.replace('_', ' ') }}</h5>
                    <p class="display-6 fw-bold">{{ value }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Status Summary -->
    <div class="row mt-4">
        {% for status, count in status_counts.items() %}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h6 class="card-subtitle text-muted">{{ status }}</h6>
                    <p class="fs-4 fw-semibold">{{ count }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Active Checkouts -->
    <div class="mt-5">
        <h4 class="fw-bold">Active Checkouts</h4>
        <p class="fs-5">{{ active_checkouts }}</p>
    </div>

    <!-- Low Stock with Filter -->
    <div class="mt-5">
        <h4 class="fw-bold mb-3">Low Stock Items</h4>
        <input type="text" class="form-control mb-3" id="stockSearch" placeholder="üîç Search by item name...">
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Quantity</th>
                        <th>Threshold</th>
                    </tr>
                </thead>
                <tbody id="stockTable">
                    {% for item in low_stock %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.threshold }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Dark Mode Toggle + Search Filter Script -->
<script>
    // Light/Dark Mode Toggle
    const toggleBtn = document.getElementById('themeToggle');
    toggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('bg-dark');
        document.body.classList.toggle('text-white');
        localStorage.setItem('theme', document.body.classList.contains('bg-dark') ? 'dark' : 'light');
    });

    // On load theme from storage
    window.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('bg-dark', 'text-white');
        }
    });

    // Filter low stock
    const stockSearch = document.getElementById('stockSearch');
    stockSearch.addEventListener('input', function () {
        const query = this.value.toLowerCase();
        document.querySelectorAll('#stockTable tr').forEach(row => {
            const name = row.children[0].textContent.toLowerCase();
            row.style.display = name.includes(query) ? '' : 'none';
        });
    });
</script>
{% endblock %}
