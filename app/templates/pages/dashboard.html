{% extends "layouts/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#shareModal">Share</button>
            <a href="{{ url_for('main.export_dashboard') }}" class="btn btn-sm btn-outline-success">Export</a>
            <span class="badge bg-primary shadow-sm fs-6">👤 {{ current_user.username }}</span>
        </div>
        <div class="btn-group me-2">
            <button class="btn btn-sm btn-outline-dark" onclick="toggleTheme()">
                🌗 Theme
            </button>
        </div>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                📅 Filter
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="filterData('week')">This week</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterData('month')">This month</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterData('all')">All time</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Notifications -->
<div id="notificationContainer" class="alert alert-info d-none" role="alert">
    <strong>Info:</strong> Dashboard updated.
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    {% for key, value in asset_counts.items() %}
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <h5 class="card-title text-capitalize">{{ key.replace('_', ' ') }}</h5>
                <p class="display-6 fw-bold">{{ value }}</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Charts -->
<div class="row mb-5">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header fw-semibold">Assets Overview</div>
            <div class="card-body">
                <canvas id="assetChart" height="150"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header fw-semibold">Status Summary</div>
            <div class="card-body">
                <canvas id="statusChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Low Stock + Pending -->
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Low Stock Alerts</h5>
                <input type="text" class="form-control form-control-sm w-50" id="lowStockSearch" placeholder="Search...">
            </div>
            <div class="card-body">
                {% if low_stock %}
                <div class="list-group" id="lowStockList">
                    {% for item in low_stock %}
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex justify-content-between">
                            <strong>{{ item.name }}</strong>
                            <span class="text-danger">{{ item.quantity }} remaining</span>
                        </div>
                        <small>Threshold: {{ item.threshold }}</small>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">✅ No items are below stock threshold.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">🔧 Pending Maintenance</div>
            <div class="card-body">
                {% if pending_maintenance > 0 %}
                <p><strong>{{ pending_maintenance }}</strong> maintenance tasks pending.</p>
                {% else %}
                <p class="text-muted">✅ No pending maintenance tasks.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="shareForm">
      <div class="modal-header">
        <h5 class="modal-title" id="shareModalLabel">Share Dashboard</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="email" class="form-control" id="email" placeholder="Enter email to share with" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Send</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function filterData(period) {
    window.location.href = `/dashboard?time_period=${period}`;
}

// Theme toggle
function toggleTheme() {
    document.body.classList.toggle("bg-dark");
    document.body.classList.toggle("text-light");

    const cards = document.querySelectorAll('.card');
    cards.forEach(card => card.classList.toggle("bg-secondary"));
}

// Low Stock Search
document.getElementById('lowStockSearch')?.addEventListener('input', function () {
    const value = this.value.toLowerCase();
    const items = document.querySelectorAll('#lowStockList .list-group-item');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(value) ? '' : 'none';
    });
});

// Asset Chart
new Chart(document.getElementById('assetChart'), {
    type: 'bar',
    data: {
        labels: Object.keys({{ asset_counts|tojson }}),
        datasets: [{
            label: 'Assets',
            data: Object.values({{ asset_counts|tojson }}),
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
        }]
    },
    options: { responsive: true }
});

// Status Chart
new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
        labels: Object.keys({{ status_counts|tojson }}),
        datasets: [{
            data: Object.values({{ status_counts|tojson }}),
            backgroundColor: ['#198754', '#ffc107', '#dc3545', '#0d6efd']
        }]
    },
    options: { responsive: true }
});

// Share
document.getElementById('shareForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    fetch('/send-dashboard-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.success ? "📧 Dashboard shared!" : "❌ Failed to send.");
        bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
    })
    .catch(err => alert("Error: " + err.message));
});
</script>
{% endblock %}
