{% extends "layouts/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div style="background-image: url('{{ url_for('static', filename='images/aljameaB.jpg') }}');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
            min-height: 100vh;
            padding: 20px;">
    
    <div class="bg-white bg-opacity-75 p-4 rounded shadow">

        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Dashboard</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#shareModal">
                        Share
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/export-dashboard'">
                        Export
                    </button>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-calendar"></i> This week
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="filterData('week')">This week</a></li>
                    <li><a class="dropdown-item" href="#" onclick="filterData('month')">This month</a></li>
                    <li><a class="dropdown-item" href="#" onclick="filterData('all')">All time</a></li>
                </ul>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            {% set total_assets = asset_counts.desktop + asset_counts.printer + asset_counts.server + asset_counts.other %}
            {% set card_data = [
                {'title': 'Total Assets', 'count': total_assets, 'class': 'primary'},
                {'title': 'Available', 'count': status_counts['Available'], 'class': 'success'},
                {'title': 'In Maintenance', 'count': status_counts['Maintenance'], 'class': 'warning'},
                {'title': 'Out of Service', 'count': status_counts['Out of Service'], 'class': 'danger'}
            ] %}
            {% for card in card_data %}
            <div class="col-md-3">
                <div class="card text-white bg-{{ card.class }} mb-3">
                    <div class="card-body">
                        <h5 class="card-title">{{ card.title }}</h5>
                        <p class="card-text display-6">{{ card.count }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4 h-100">
                    <div class="card-header">
                        <h5>Asset Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="assetChart" width="100%" height="400" aria-label="Asset Chart" role="img"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4 h-100">
                    <div class="card-header">
                        <h5>Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart" width="100%" height="400" aria-label="Status Chart" role="img"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5>Low Stock Alerts</h5>
                    </div>
                    <div class="card-body">
                        {% if low_stock %}
                        <div class="list-group">
                            {% for item in low_stock %}
                            <a href="{{ url_for('stationery.view_stationery') }}" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">{{ item.item_type }} Paper</h6>
                                    <small class="text-danger">{{ item.quantity }} {{ item.unit }} remaining</small>
                                </div>
                                <p class="mb-1">Location: {{ item.location or 'General' }}</p>
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No low stock items</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5>Pending Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <a href="{{ url_for('maintenance.view_maintenance') }}" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between">
                                    <h6>Pending Maintenance</h6>
                                    <span class="badge bg-warning rounded-pill">{{ pending_maintenance }}</span>
                                </div>
                            </a>
                            <a href="{{ url_for('checkout.active_checkouts') }}" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between">
                                    <h6>Active Checkouts</h6>
                                    <span class="badge bg-primary rounded-pill">{{ active_checkouts }}</span>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Modal -->
        <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="shareForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="shareModalLabel">Share Dashboard</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="email" class="form-label">Recipient Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Send Report</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div> <!-- end white content box -->
</div> <!-- end background wrapper -->
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const assetChart = new Chart(document.getElementById('assetChart'), {
    type: 'doughnut',
    data: {
        labels: ['Desktops', 'Printers', 'Servers', 'Other'],
        datasets: [{
            data: [{{ asset_counts.desktop }}, {{ asset_counts.printer }}, {{ asset_counts.server }}, {{ asset_counts.other }}],
            backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'],
            hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#dda20a'],
            borderColor: 'rgba(234, 236, 244, 1)',
        }]
    },
    options: {
        maintainAspectRatio: false,
        cutout: '75%',
        plugins: {
            legend: { position: 'right' }
        }
    }
});

const statusChart = new Chart(document.getElementById('statusChart'), {
    type: 'bar',
    data: {
        labels: ['Available', 'In-use', 'Maintenance', 'Out of Service'],
        datasets: [{
            label: 'Assets',
            data: [
                {{ status_counts.Available }},
                {{ status_counts['In-use'] }},
                {{ status_counts.Maintenance }},
                {{ status_counts['Out of Service'] }}
            ],
            backgroundColor: ['#1cc88a', '#4e73df', '#f6c23e', '#e74a3b']
        }]
    },
    options: {
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        },
        plugins: {
            legend: { display: false }
        }
    }
});

document.getElementById('shareForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    fetch('/send-dashboard-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Dashboard report sent!');
            bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
        } else {
            alert('Failed to send: ' + data.error);
        }
    })
    .catch(err => alert('Error: ' + err.message));
});

function filterData(timePeriod) {
    window.location.href = `/dashboard?time_period=${timePeriod}`;
}
</script>
{% endblock %}
